name: CI/CD HTML/CSS

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  
  # Job 1: CI - Validação do código
  
  ci:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout do código
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Verificar se index.html existe na raiz
      - name: Verificar index.html
        run: |
          if [ ! -f "index.html" ]; then
            echo "ERRO: index.html não encontrado na raiz do projeto"
            exit 1
          fi

      # 3. Instalar HTMLHint (linter)
      - name: Instalar HTMLHint
        run: npm install -g htmlhint

      # 4. Validar HTML
      - name: Rodar HTMLHint
        run: htmlhint "**/*.html"

      # 5. Verificar arquivos > 500KB
      - name: Verificar arquivos grandes
        run: |
          find . -type f -size +500k | while read file; do
            echo "ERRO: Arquivo muito grande encontrado: $file"
            exit 1
          done || true

      # 6. Verificar TODO, FIXME, senha e password
      - name: Verificar termos sensíveis
        run: |
          # Busca somente em arquivos HTML, CSS e JS
          if grep -R -i -E "TODO|FIXME|senha|password" --include=\*.html --include=\*.css --include=\*.js .; then
            echo "ERRO: Comentários ou termos sensíveis encontrados!"
            exit 1
          fi

      # 7. Verificar links e imagens
      - name: Validar links e imagens
        run: |
          urls=$(grep -Eo '<(a|img)[^>]+(href|src)="[^"]+"' **/*.html | grep -Eo '(href|src)="[^"]+"' | cut -d'"' -f2)
          for url in $urls; do
            if [[ "$url" == http* ]]; then
              status=$(curl -s -o /dev/null -w "%{http_code}" "$url")
              if [ "$status" -ge 400 ]; then
                echo "ERRO: URL inválida encontrada: $url"
                exit 1
              fi
            else
              if [ ! -f "$url" ]; then
                echo "ERRO: Arquivo local não encontrado: $url"
                exit 1
              fi
            fi
          done

  
  # Job 2: CD - Deploy para GitHub Pages
  
  deploy:
    runs-on: ubuntu-latest
    needs: ci
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configurar GitHub Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Deploy para GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      
      - name: Notificar Discord se falhar
        if: failure()
        uses: appleboy/discord-action@v0.1.2
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          message: " Deploy falhou no GitHub Actions para o projeto HTML/CSS!"

